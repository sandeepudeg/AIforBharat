class ChatInterface{constructor(){this.chatWidget=document.getElementById('chat-widget'),this.chatToggle=document.getElementById('chat-toggle'),this.chatMessages=document.getElementById('chat-messages'),this.chatInput=document.getElementById('chat-input'),this.chatSend=document.getElementById('chat-send'),this.chatClose=document.getElementById('chat-close'),this.messages=[],this.isOpen=!1,this.init()}init(){this.chatToggle.addEventListener('click',()=>this.toggle()),this.chatClose.addEventListener('click',()=>this.close()),this.chatSend.addEventListener('click',()=>this.sendMessage()),this.chatInput.addEventListener('keypress',e=>{'Enter'===e.key&&this.sendMessage()}),this.loadHistory(),this.addSystemMessage('Welcome to Pune Knowledge Base! Ask me anything about Pune - food, culture, attractions, and more.')}toggle(){this.isOpen?this.close():this.open()}open(){this.chatWidget.classList.add('active'),this.isOpen=!0,this.chatInput.focus()}close(){this.chatWidget.classList.remove('active'),this.isOpen=!1}sendMessage(){const e=this.chatInput.value.trim();e&&(this.addUserMessage(e),this.chatInput.value='',this.showTypingIndicator(),this.getResponse(e))}addUserMessage(e){this.addMessage(e,'user')}addSystemMessage(e){this.addMessage(e,'system')}addMessage(e,t){const s=document.createElement('div');s.className=`chat-message ${t}`;const a=document.createElement('div');a.className=`message-bubble ${t}`,a.textContent=e,s.appendChild(a),this.chatMessages.appendChild(s),this.chatMessages.scrollTop=this.chatMessages.scrollHeight,this.messages.push({type:t,message:e,timestamp:new Date().toISOString()}),this.saveHistory()}showTypingIndicator(){const e=document.createElement('div');e.className='chat-message system',e.id='typing-indicator';const t=document.createElement('div');t.className='message-bubble system',t.innerHTML='<span class="typing"><span></span><span></span><span></span></span>',e.appendChild(t),this.chatMessages.appendChild(e),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}removeTypingIndicator(){const e=document.getElementById('typing-indicator');e&&e.remove()}async getResponse(e){try{const t=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:e})});if(!t.ok)throw new Error('Failed to get response');const s=await t.json();this.removeTypingIndicator(),s.response&&this.addSystemMessage(s.response),s.articles&&s.articles.length>0&&this.addRelatedArticles(s.articles)}catch(e){console.error('Chat error:',e),this.removeTypingIndicator(),this.addSystemMessage('Sorry, I encountered an error. Please try again.')}}addRelatedArticles(e){const t=document.createElement('div');t.className='chat-message system';const s=document.createElement('div');s.className='message-bubble system';let a='<strong>Related articles:</strong><ul style="margin: 0.5rem 0; padding-left: 1.5rem;">';e.forEach(e=>{a+=`<li><a href="/article/${e.id}" target="_blank">${escapeHtml(e.title)}</a></li>`}),a+='</ul>',s.innerHTML=a,t.appendChild(s),this.chatMessages.appendChild(t),this.chatMessages.scrollTop=this.chatMessages.scrollHeight}saveHistory(){try{localStorage.setItem('chat_history',JSON.stringify(this.messages))}catch(e){console.warn('Failed to save chat history:',e)}}loadHistory(){try{const e=localStorage.getItem('chat_history');if(e){this.messages=JSON.parse(e);const t=this.messages.slice(-10);t.forEach(e=>{this.addMessage(e.message,e.type)})}}catch(e){console.warn('Failed to load chat history:',e)}}clearHistory(){this.messages=[],this.chatMessages.innerHTML='',localStorage.removeItem('chat_history'),this.addSystemMessage('Chat history cleared.')}}document.addEventListener('DOMContentLoaded',function(){window.chatInterface=new ChatInterface()});const style=document.createElement('style');style.textContent=`.typing{display:inline-flex;gap:4px}.typing span{width:8px;height:8px;border-radius:50%;background-color:#999;animation:typing 1.4s infinite}.typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}@keyframes typing{0%,60%,100%{opacity:.5;transform:translateY(0)}30%{opacity:1;transform:translateY(-10px)}}`,document.head.appendChild(style);
