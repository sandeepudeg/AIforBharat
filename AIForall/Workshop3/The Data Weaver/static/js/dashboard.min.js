let currentMetric="imperial",currentLocation={country:null,state:null,district:null},currentTimeRange="weekly";const locationData={usa:{name:"United States",states:{ny:{name:"New York",districts:["Manhattan","Brooklyn","Queens","Bronx","Staten Island"]},ca:{name:"California",districts:["Los Angeles","San Francisco","San Diego","Sacramento"]},tx:{name:"Texas",districts:["Houston","Dallas","Austin","San Antonio"]},fl:{name:"Florida",districts:["Miami","Orlando","Tampa","Jacksonville"]}}},india:{name:"India",states:{mh:{name:"Maharashtra",districts:["Mumbai","Pune","Nagpur","Aurangabad"]},dl:{name:"Delhi",districts:["New Delhi","East Delhi","West Delhi","North Delhi"]},ka:{name:"Karnataka",districts:["Bangalore","Mysore","Mangalore","Belgaum"]},tn:{name:"Tamil Nadu",districts:["Chennai","Coimbatore","Madurai","Salem"]}}},uk:{name:"United Kingdom",states:{en:{name:"England",districts:["London","Manchester","Birmingham","Leeds"]},sc:{name:"Scotland",districts:["Edinburgh","Glasgow","Aberdeen","Dundee"]},wa:{name:"Wales",districts:["Cardiff","Swansea","Newport","Wrexham"]}}},canada:{name:"Canada",states:{on:{name:"Ontario",districts:["Toronto","Ottawa","Hamilton","London"]},bc:{name:"British Columbia",districts:["Vancouver","Victoria","Surrey","Burnaby"]},qc:{name:"Quebec",districts:["Montreal","Quebec City","Laval","Gatineau"]}}}};function fahrenheitToCelsius(e){return(e-32)*5/9}function celsiusToFahrenheit(e){return 9*e/5+32}function mphToKmh(e){return 1.60934*e}function kmhToMph(e){return e/1.60934}function formatTemperature(e){return"metric"===currentMetric?`${fahrenheitToCelsius(e).toFixed(1)}Â°C`:`${e.toFixed(1)}Â°F`}function formatWindSpeed(e){return"metric"===currentMetric?`${mphToKmh(e).toFixed(1)} km/h`:`${e.toFixed(1)} mph`}function getYAxisLabel(e){const t={temp:"metric"===currentMetric?"Temperature (Â°C)":"Temperature (Â°F)",humidity:"Humidity (%)",wind:"metric"===currentMetric?"Wind (km/h)":"Wind (mph)",pressure:"Pressure (mb)",precip:"Precipitation (mm)",uv:"UV Index"};return t[e]||""}async function fetchFromAPI(e){try{const t=await fetch(e);if(!t.ok){const e=await t.json();throw new Error(e.message||`API error: ${t.status}`)}return await t.json()}catch(t){throw console.error(`Error fetching from ${e}:`,t),t}}function updateLastUpdatedTime(e){const t=new Date(e).toLocaleTimeString();document.querySelector(".last-updated").textContent=`Last Updated: ${t}`}document.getElementById("countrySelect").addEventListener("change",function(){const e=this.value,t=document.getElementById("stateSelect"),n=document.getElementById("districtSelect");t.innerHTML='<option value="">Select State</option>',n.innerHTML='<option value="">Select District</option>',currentLocation.country=e,currentLocation.state=null,currentLocation.district=null,e&&locationData[e]&&Object.entries(locationData[e].states).forEach(([e,n])=>{const o=document.createElement("option");o.value=e,o.textContent=n.name,t.appendChild(o)})}),document.getElementById("stateSelect").addEventListener("change",function(){const e=document.getElementById("countrySelect").value,t=this.value,n=document.getElementById("districtSelect");n.innerHTML='<option value="">Select District</option>',currentLocation.state=t,currentLocation.district=null,e&&t&&locationData[e]&&locationData[e].states[t].districts.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)})}),document.getElementById("districtSelect").addEventListener("change",async function(){if(this.value){const e=document.getElementById("countrySelect").value,t=document.getElementById("stateSelect").value,n=this.value;currentLocation.country=e,currentLocation.state=t,currentLocation.district=n,await fetchAndUpdateLocationData(e,t,n)}}),async function fetchAndUpdateLocationData(e,t,n){try{const o=document.createElement("div");o.className="loading-indicator",o.textContent="Loading data...",document.body.appendChild(o);const a=await fetchFromAPI(`/api/weather/${e}/${t}/${n}`);updateWeatherPanel(a),updateLastUpdatedTime(a.timestamp);const i=await fetchFromAPI(`/api/pollen/${e}/${t}/${n}`);updatePollenPanel(i);const r=await fetchFromAPI(`/api/correlation/${e}/${t}/${n}`);updateCorrelationPanel(r),o.remove()}catch(e){console.error("Error fetching location data:",e),alert(`Error loading data: ${e.message}`);const t=document.querySelector(".loading-indicator");t&&t.remove()}}();function updateWeatherPanel(e){const t=document.querySelector(".weather-item:nth-child(1) value"),n=document.querySelector(".weather-item:nth-child(2) value"),o=document.querySelector(".weather-item:nth-child(3) value"),a=document.querySelector(".weather-item:nth-child(4) value"),i=document.querySelector(".weather-item:nth-child(5) value"),r=document.querySelector(".weather-item:nth-child(6) value"),c=document.querySelector(".weather-item:nth-child(7) value");t&&(t.textContent=formatTemperature(e.temperature)),n&&(n.textContent=`${e.humidity}%`),o&&(o.textContent=formatWindSpeed(e.wind_speed)),a&&(a.textContent=`${e.pressure} mb`),i&&(i.textContent=`${e.precipitation} mm`),r&&(r.textContent=`${e.uv_index} (${getUVCategory(e.uv_index)})`),c&&(c.textContent=e.conditions||"N/A")}function getUVCategory(e){return e<3?"Low":e<6?"Moderate":e<8?"High":e<11?"Very High":"Extreme"}function updatePollenPanel(e){["grass","tree","weed","ragweed","mold"].forEach((t,n)=>{const o=document.querySelector(`.pollen-item:nth-child(${n+1})`);if(o&&e.pollen_types[t]){const n=e.pollen_types[t],a=o.querySelector("value"),i=o.querySelector(".pollen-level");a&&(a.innerHTML=`${n.concentration} <span class="pollen-level ${n.severity.toLowerCase()}">${n.severity}</span>`)}})}function updateCorrelationPanel(e){const t=document.querySelector(".correlation-container");if(!t||!e.correlations)return;t.querySelectorAll(".correlation-item").forEach((t,n)=>{if(e.correlations[n]){const o=e.correlations[n],a=t.querySelector(".correlation-strength"),i=t.querySelector(".correlation-value");a&&(a.className=`correlation-strength ${function getCorrelationStrengthClass(e){const t=Math.abs(e);return t>=.7?"strong":t>=.4?"moderate":"weak"}(o.correlation_coefficient)}`,a.textContent=`${o.correlation_coefficient.toFixed(2)} (${o.strength})`),i&&(i.textContent=o.explanation)}})}document.querySelectorAll(".metric-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".metric-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),currentMetric=this.dataset.metric;const e=document.querySelector(".weather-item:nth-child(1) value"),t=document.querySelector(".weather-item:nth-child(3) value");if(e&&e.textContent){const n=e.textContent.match(/[\d.]+/);n&&(e.textContent=formatTemperature(parseFloat(n[0])))}if(t&&t.textContent){const e=t.textContent.match(/[\d.]+/);e&&(t.textContent=formatWindSpeed(parseFloat(e[0])))}updateChartAxisLabels(),localStorage.setItem("metricSystem",currentMetric)})}),function loadMetricPreference(){const e=localStorage.getItem("metricSystem");if(e){currentMetric=e;const t=document.querySelector(`.metric-btn[data-metric="${e}"]`);t&&(document.querySelectorAll(".metric-btn").forEach(e=>e.classList.remove("active")),t.classList.add("active"))}}();function updateChartAxisLabels(){temperatureChart&&temperatureChart.options.scales&&(temperatureChart.options.scales.y.title.text=getYAxisLabel("temp"),temperatureChart.options.scales.y2.title.text=getYAxisLabel("humidity"),temperatureChart.options.scales.y3.title.text=getYAxisLabel("wind"),temperatureChart.options.scales.y4.title.text=getYAxisLabel("pressure"),temperatureChart.options.scales.y5.title.text=getYAxisLabel("precip"),temperatureChart.options.scales.y6.title.text=getYAxisLabel("uv"),temperatureChart.update()),correlationChart&&correlationChart.options.scales&&(correlationChart.options.scales.y.title.text=getYAxisLabel("temp"),correlationChart.options.scales.y2.title.text=getYAxisLabel("humidity"),correlationChart.options.scales.y3.title.text=getYAxisLabel("wind"),correlationChart.options.scales.y4.title.text=getYAxisLabel("pressure"),correlationChart.options.scales.y5.title.text=getYAxisLabel("precip"),correlationChart.options.scales.y6.title.text=getYAxisLabel("uv"),correlationChart.update())}const parameterData={temp:{label:"ðŸŒ¡ï¸ Temperature",data:[65,68,72,75,73,70,68],color:"#FF4444"},humidity:{label:"ðŸ’§ Humidity",data:[55,60,65,62,68,70,72],color:"#0099FF"},wind:{label:"ðŸ’¨ Wind Speed",data:[8,10,12,15,14,11,9],color:"#00CC44"},pressure:{label:"ðŸ”½ Pressure",data:[1010,1012,1013,1011,1009,1008,1010],color:"#FF9900"},precip:{label:"ðŸŒ§ï¸ Precipitation",data:[0,0,0,2,5,1,0],color:"#9933FF"},uv:{label:"â˜€ï¸ UV Index",data:[3,4,6,7,6,5,4],color:"#FFDD00"}},parameterFeedback={temp:"Temperature increases pollen release from plants.",humidity:"High humidity reduces airborne pollen.",wind:"Wind speed significantly increases pollen dispersion.",pressure:"Low pressure triggers higher pollen release.",precip:"Precipitation washes pollen out of the air.",uv:"High UV index correlates with increased pollen levels."};function updateChart(){const e=[],t=[];let n=new Set(["y"]);document.querySelectorAll("#tempCheck, #humidityCheck, #windCheck, #pressureCheck, #precipCheck, #uvCheck").forEach(o=>{if(o.checked){const a=o.id.replace("Check","");e.push(parameterData[a].label);const i={temp:"y",humidity:"y1",wind:"y2",pressure:"y3",precip:"y4",uv:"y5"}[a];n.add(i),t.push({label:parameterData[a].label,data:parameterData[a].data,borderColor:parameterData[a].color,backgroundColor:parameterData[a].color+"20",borderWidth:2,tension:.4,fill:!1,yAxisID:i})}}),temperatureChart&&(temperatureChart.data.datasets=t,Object.keys({temp:"y",humidity:"y1",wind:"y2",pressure:"y3",precip:"y4",uv:"y5"}).forEach(e=>{const o={temp:"y",humidity:"y1",wind:"y2",pressure:"y3",precip:"y4",uv:"y5"}[e];temperatureChart.options.scales[o]&&(temperatureChart.options.scales[o].display=n.has(o))}),temperatureChart.update());const o=document.getElementById("comparativeFeedback");0===e.length?o.innerHTML="<strong>ðŸ“Š Comparative Analysis:</strong> Select parameters to see how they interact with pollen levels.":1===e.length?o.innerHTML=`<strong>ðŸ“Š Single Parameter Analysis:</strong> ${e[0]} is displayed. ${parameterFeedback[Array.from(document.querySelectorAll("#tempCheck, #humidityCheck, #windCheck, #pressureCheck, #precipCheck, #uvCheck")).find(e=>e.checked).id.replace("Check","")]}`:o.innerHTML=`<strong>ðŸ“Š Multi-Parameter Analysis:</strong> Showing ${e.join(", ")}. These parameters work together to influence pollen levels. High wind combined with low humidity and high temperature creates ideal conditions for maximum pollen dispersion.`}document.querySelectorAll("#tempCheck, #humidityCheck, #windCheck, #pressureCheck, #precipCheck, #uvCheck").forEach(e=>{e.addEventListener("change",updateChart)});let temperatureChart;const temperatureCtx=document.getElementById("temperatureChart").getContext("2d");temperatureChart=new Chart(temperatureCtx,{type:"line",data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],datasets:[{label:"ðŸŒ¡ï¸ Temperature",data:[65,68,72,75,73,70,68],borderColor:"#ff6b6b",backgroundColor:"rgba(255, 107, 107, 0.1)",borderWidth:3,fill:!0,tension:.4,pointRadius:6,pointBackgroundColor:"#ff6b6b",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:8,yAxisID:"y"}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,labels:{font:{size:12}}}},scales:{y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"Temperature (Â°F)"},min:60,max:80},y1:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Humidity (%)"},min:0,max:100,grid:{drawOnChartArea:!1}},y2:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Wind (mph)"},min:0,max:20,grid:{drawOnChartArea:!1}},y3:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Pressure (mb)"},min:1e3,max:1020,grid:{drawOnChartArea:!1}},y4:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Precipitation (mm)"},min:0,max:10,grid:{drawOnChartArea:!1}},y5:{type:"linear",display:!1,position:"right",title:{display:!0,text:"UV Index"},min:0,max:10,grid:{drawOnChartArea:!1}}}}}),document.getElementById("pollenChart").getContext("2d");let pollenChart=new Chart(document.getElementById("pollenChart").getContext("2d"),{type:"bar",data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],datasets:[{label:"ðŸŒ¾ Grass Pollen",data:[600,650,850,800,750,500,450],backgroundColor:"#00CC44",borderColor:"#00AA33",borderWidth:2},{label:"ðŸŒ³ Tree Pollen",data:[300,350,450,400,380,250,200],backgroundColor:"#FF9900",borderColor:"#DD7700",borderWidth:2},{label:"ðŸŒ± Weed Pollen",data:[100,120,150,140,130,80,60],backgroundColor:"#9933FF",borderColor:"#7722DD",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,labels:{font:{size:12}}}},scales:{x:{stacked:!1},y:{stacked:!1,title:{display:!0,text:"Pollen Count"}}}}}),document.getElementById("correlationChart").getContext("2d");let correlationChart=new Chart(document.getElementById("correlationChart").getContext("2d"),{type:"line",data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],datasets:[{label:"ðŸŒ¡ï¸ Temperature (Â°F)",data:[65,68,72,75,73,70,68],borderColor:"#FF4444",backgroundColor:"rgba(255, 68, 68, 0.1)",borderWidth:2,yAxisID:"y",tension:.4},{label:"ðŸŒ¾ Grass Pollen",data:[1e3,1120,1450,1340,1260,830,710],borderColor:"#00CC44",backgroundColor:"rgba(0, 204, 68, 0.1)",borderWidth:2,yAxisID:"y1",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,labels:{font:{size:12}}}},scales:{y:{type:"linear",display:!0,position:"left",title:{display:!0,text:"Temperature (Â°F)"},min:60,max:80},y1:{type:"linear",display:!0,position:"right",title:{display:!0,text:"Grass Pollen"},min:500,max:1500,grid:{drawOnChartArea:!1}},y2:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Humidity (%)"},min:0,max:100,grid:{drawOnChartArea:!1}},y3:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Wind (mph)"},min:0,max:20,grid:{drawOnChartArea:!1}},y4:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Pressure (mb)"},min:1e3,max:1020,grid:{drawOnChartArea:!1}},y5:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Precipitation (mm)"},min:0,max:10,grid:{drawOnChartArea:!1}},y6:{type:"linear",display:!1,position:"right",title:{display:!0,text:"UV Index"},min:0,max:10,grid:{drawOnChartArea:!1}},y7:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Tree Pollen"},min:400,max:900,grid:{drawOnChartArea:!1}},y8:{type:"linear",display:!1,position:"right",title:{display:!0,text:"Weed Pollen"},min:200,max:500,grid:{drawOnChartArea:!1}}}}}),function updatePollenChart(){const e=[];document.querySelectorAll("#grassPollenCheck, #treePollenCheck, #weedPollenCheck").forEach(t=>{if(t.checked){const n=t.id.replace("PollenCheck","").toLowerCase();if({grass:{label:"ðŸŒ¾ Grass Pollen",data:[600,650,850,800,750,500,450],backgroundColor:"#00CC44",borderColor:"#00AA33"},tree:{label:"ðŸŒ³ Tree Pollen",data:[300,350,450,400,380,250,200],backgroundColor:"#FF9900",borderColor:"#DD7700"},weed:{label:"ðŸŒ± Weed Pollen",data:[100,120,150,140,130,80,60],backgroundColor:"#9933FF",borderColor:"#7722DD"}}[n]){const t={grass:{label:"ðŸŒ¾ Grass Pollen",data:[600,650,850,800,750,500,450],backgroundColor:"#00CC44",borderColor:"#00AA33"},tree:{label:"ðŸŒ³ Tree Pollen",data:[300,350,450,400,380,250,200],backgroundColor:"#FF9900",borderColor:"#DD7700"},weed:{label:"ðŸŒ± Weed Pollen",data:[100,120,150,140,130,80,60],backgroundColor:"#9933FF",borderColor:"#7722DD"}}[n];e.push({label:t.label,data:t.data,backgroundColor:t.backgroundColor,borderColor:t.borderColor,borderWidth:2})}}}),pollenChart&&(pollenChart.data.datasets=e,pollenChart.update())}();document.querySelectorAll("#grassPollenCheck, #treePollenCheck, #weedPollenCheck").forEach(e=>{e.addEventListener("change",updatePollenChart)});const correlationWeatherData={temp:{label:"ðŸŒ¡ï¸ Temperature",data:[65,68,72,75,73,70,68],color:"#FF4444",yAxis:"y"},humidity:{label:"ðŸ’§ Humidity",data:[55,60,65,62,68,70,72],color:"#0099FF",yAxis:"y2"},wind:{label:"ðŸ’¨ Wind Speed",data:[8,10,12,15,14,11,9],color:"#00CC44",yAxis:"y3"},pressure:{label:"ðŸ”½ Pressure",data:[1010,1012,1013,1011,1009,1008,1010],color:"#FF9900",yAxis:"y4"},precip:{label:"ðŸŒ§ï¸ Precipitation",data:[0,0,0,2,5,1,0],color:"#9933FF",yAxis:"y5"},uv:{label:"â˜€ï¸ UV Index",data:[3,4,6,7,6,5,4],color:"#FFDD00",yAxis:"y6"}},correlationPollenData={grass:{label:"ðŸŒ¾ Grass Pollen",data:[1e3,1120,1450,1340,1260,830,710],color:"#00CC44",yAxis:"y1"},tree:{label:"ðŸŒ³ Tree Pollen",data:[600,650,850,800,750,500,450],color:"#FF9900",yAxis:"y7"},weed:{label:"ðŸŒ± Weed Pollen",data:[300,350,450,400,380,250,200],color:"#9933FF",yAxis:"y8"}};function updateCorrelationChart(){const e=[],t=new Set;document.querySelectorAll("#corrTempCheck, #corrHumidityCheck, #corrWindCheck, #corrPressureCheck, #corrPrecipCheck, #corrUVCheck").forEach(n=>{if(n.checked){const o=n.id.replace("corr","").replace("Check","").toLowerCase();if(correlationWeatherData[o]){const n=correlationWeatherData[o];t.add(n.yAxis),e.push({label:n.label,data:n.data,borderColor:n.color,backgroundColor:n.color+"20",borderWidth:2,tension:.4,yAxisID:n.yAxis})}}}),document.querySelectorAll("#corrGrassCheck, #corrTreeCheck, #corrWeedCheck").forEach(n=>{if(n.checked){const o=n.id.replace("corr","").replace("Check","").toLowerCase();if(correlationPollenData[o]){const n=correlationPollenData[o];t.add(n.yAxis),e.push({label:n.label,data:n.data,borderColor:n.color,backgroundColor:n.color+"20",borderWidth:2,tension:.4,yAxisID:n.yAxis})}}}),correlationChart&&(correlationChart.data.datasets=e,["y","y1","y2","y3","y4","y5","y6","y7","y8"].forEach(e=>{correlationChart.options.scales[e]&&(correlationChart.options.scales[e].display=t.has(e))}),correlationChart.update());const n=document.getElementById("correlationFeedback");if(0===document.querySelectorAll("#corrTempCheck, #corrHumidityCheck, #corrWindCheck, #corrPressureCheck, #corrPrecipCheck, #corrUVCheck:checked, #corrGrassCheck, #corrTreeCheck, #corrWeedCheck:checked").length)n.innerHTML="<strong>ðŸ”— Correlation Analysis:</strong> Select weather parameters and pollen types to analyze their correlations.";else{const e=[],o=[];document.querySelectorAll("#corrTempCheck, #corrHumidityCheck, #corrWindCheck, #corrPressureCheck, #corrPrecipCheck, #corrUVCheck:checked").forEach(t=>{const n=t.id.replace("corr","").replace("Check","").toLowerCase();correlationWeatherData[n]&&e.push(correlationWeatherData[n].label)}),document.querySelectorAll("#corrGrassCheck, #corrTreeCheck, #corrWeedCheck:checked").forEach(t=>{const n=t.id.replace("corr","").replace("Check","").toLowerCase();correlationPollenData[n]&&o.push(correlationPollenData[n].label)});const a=[...e,...o];n.innerHTML=`<strong>ðŸ”— Correlation Analysis:</strong> Analyzing ${a.join(", ")}. The chart shows how these parameters correlate with each other over time.`}}document.querySelectorAll("#corrTempCheck, #corrHumidityCheck, #corrWindCheck, #corrPressureCheck, #corrPrecipCheck, #corrUVCheck, #corrGrassCheck, #corrTreeCheck, #corrWeedCheck").forEach(e=>{e.addEventListener("change",updateCorrelationChart)}),document.querySelectorAll(".time-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".time-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active");const e=this.textContent.toLowerCase().split(" ")[1];currentTimeRange=e;const t=document.querySelector(".date-range");if(t){const n=new Date,o=new Date;let a;switch(e){case"weekly":o.setDate(n.getDate()-6),a=o;break;case"monthly":a=new Date(n.getFullYear(),n.getMonth(),1);break;case"half-yearly":a=new Date(n),a.setMonth(n.getMonth()-6);break;case"yearly":a=new Date(n.getFullYear(),0,1)}t.textContent=`${a.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})} - ${n.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`}})}),document.querySelector(".btn-export").addEventListener("click",async function(){if(!currentLocation.country||!currentLocation.state||!currentLocation.district)return void alert("Please select a location first");try{const e=await fetchFromAPI(`/api/weather/${currentLocation.country}/${currentLocation.state}/${currentLocation.district}`),t=await fetchFromAPI(`/api/pollen/${currentLocation.country}/${currentLocation.state}/${currentLocation.district}`),n=await fetchFromAPI(`/api/correlation/${currentLocation.country}/${currentLocation.state}/${currentLocation.district}`),o={metadata:{exportDate:(new Date).toISOString(),location:currentLocation,timeRange:currentTimeRange,metricSystem:currentMetric},weather:e,pollen:t,correlations:n},a=JSON.stringify(o,null,2),i=new Blob([a],{type:"application/json"}),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download=`weather-pollen-data-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}catch(e){console.error("Error exporting data:",e),alert(`Error exporting data: ${e.message}`)}}),document.querySelector(".btn-refresh").addEventListener("click",async function(){if(!currentLocation.country||!currentLocation.state||!currentLocation.district)return void alert("Please select a location first");await fetchAndUpdateLocationData(currentLocation.country,currentLocation.state,currentLocation.district)}),document.addEventListener("DOMContentLoaded",function(){loadMetricPreference();const e=document.getElementById("countrySelect");e.options.length>1&&(e.value="usa",e.dispatchEvent(new Event("change")))}),new IntersectionObserver((e,t)=>{e.forEach(e=>{e.isIntersecting&&(temperatureChart&&temperatureChart.resize(),pollenChart&&pollenChart.resize(),correlationChart&&correlationChart.resize(),t.unobserve(e.target))})},{threshold:.1}).observe(document.querySelector(".charts-section"));